- Дата создания: 2018-03-06
- RFC PR:
- RFC Issue:
- Flexberry

# Сортировка записей изменений аудита

## Краткое описание

> Возникла необходимость дополнительной обработки объектов после обновления. При этом критичным условием было что бы обработка выполнялась в том порядке, в котором объекты обновляются в бд. Дополнительным условием было выполнение обработки не только изменившихся объектов, но и соответствующих им записей изменений аудита.

## Обоснование

> Сейчас объекты обновляются в бд в порядке зависимостей графа связности. Но при этом запись аудита изменений идёт в произвольном порядке, не совпадающем с реальным порядком обновления объектов. Такое поведение не позволяет использовать ведение аудита, например, для отправки изменений другому приложению, так как данные будут приняты не правильном порядке и не смогут быть корректно обработаны.

## Детальное проектирование

> Текущее решение ведения аудита изменений не подходит по двум причинам:
> 1. Запись аудита ведется в произвольном порядке. - сборка NewPlatform.Flexberry.ORM.
> 2. Объекты, обновленные одной транзакцией, помечаются в аудите одной датой операции. - сборка NewPlatform.Flexberry.Audit.

> В Flexberry.ORM необходимо реализовать запись изменений аудита в порядке, совпадающем с реальным порядком обновления объектов в бд.
Сейчас реализована простая сортировка записей аудита, за счет списка типов в порядке графа связности. Этот порядок соответствует “Update/Insert” порядку инструкций записи объектов в бд. Это решение не подходит так, как реальное обновление может отличаться от порядка объектов в графе связности (например, при удалении объектов порядок обратный).

> Сортировку можно реализовать следующим способом:
> Необходимо заранее cформировать список обновляемых объектов и инструкций бд в порядке выполнения запросов к бд с учётом логики описанной в SQLDataService.UpdateObjects и методе SQLDataService.RunCommands. Следуя по отсортированному списку выполнять запись изменений аудита в методе AuditOperation и выполнять инструкции к бд в методе RunCommands.

> Для фактического времени записи операции аудита создать новое поле с фактической датой записи операции аудита в сущность AuditEntity или создать настройку, что бы в OperationTime возможно было записывать фактическое время, а не время выполнения транзакции. 

## Документирование и обучение

> Изменение документации NewPlatform.Flexberry.ORM и NewPlatform.Flexberry.Audit.

## Недостатки

> Недостатком может являться увелечение времени обработки сохранения объектов в бд. 
> Дополнительное поле в AuditEntity повлечет изменение структуры бд аудита в существующих решениях. 
 
## Альтернативы

> Альтернативными вариантами является не сортировка записей аудита, а возможность выполнения некоторых действий, во время или после фиксации изменения объектов в бд, с отсортированным списком обновляемых объектов.
> Сейчас для выполнения некоторых действий после обновления объекта и записи изменений аудита, существует несколько способов:
> 1. Событие AfterUpdateObjects - событие, срабатывающее после выполнения действий по изменению объектов в бд и записи аудита изменения. На вход получает список обновленных объектов.
> * Плюсы
>   - Срабатывает после записи транзакции изменения в бд, т.е. нет вмешательства в работу записи изменений и аудита
> * Минусы
>   - Не получает на вход удалённые объекты
>   - Объекты на входе в произвольном порядке
> - Нет привязки к данным аудита, т.е. для того, чтобы получить только что записанные данные аудита, понадобиться дополнительно вычитать их из бд
> 2. Создание своего сервиса аудита IAuditService, с переопределением методов AuditOperation и RatifyAuditOperationWithAutoFields
>    1. Метод AuditOperation - запись аудита изменения, принимает на вход список объектов на обновление, на выходе получает список сущностей AuditAdditionalInfo. AuditAdditionalInfo содержит ключ и тип обновляемого объекта, а также ключ соответствующей записи аудита - AuditEntity.
>       * Плюсы: 
>         - можем работать со списком всех объектов, которые были посланы на обновление
>         - через сущность AuditAdditionalInfo можем получить ключ записанной AuditEntity
>       * Минусы:
>         - реализована “простая” сортировка обновляемых объектов
>         - реальные изменения объекта в этот момент ещё не произошли и запись аудита в этот момент ещё не подтверждена, т.е. в пост обработке нужно будет учитывать сценарий что изменение могли не произойти в следствии ошибки
>    2. RatifyAuditOperationWithAutoFields - фиксация операции аудита, на вход получает список AuditAdditionalInfo, полученные в AuditOperation, на выходе булевское значение, обозначающее что метод, выполнился без ошибок
>       * Плюсы:
>         - происходит в момент фиксации операции аудита, т.е. можно выполнять дополнительные действия только в случаи успешного выполнения операции
>       * Минусы:
>         - список AuditAdditionalInfo отсортирован “простой” сортировкой и зависит от сортировки объектов, переданных в AuditOperation
>         - нет доступа к обновляемым объектам, есть возможность только обрабатывать AuditAdditionalInfo
 
> Отсюда вытекают следующие возможные варианты решения:
> 1. Доработка метода AfterUpdateObjects.
> 
> Для получения отсортированного списка обновлённых объектов необходимо доработать метод SQLDataService.RunCommands, при выполнении запроса в бд, в дополнительный список должен сохраняться объект, по которому было произведено действие.
> Включать в список удалённые объекты
> Из списка AuditAdditionalInfo можно получить ключи записей аудита и передавать в событие Dictionary c объектами и ключами соответствующими изменениями аудита AuditEntity
> 
> 2. Доработка метода AuditOperation
> 
> Доработка этого метода потребует иметь заранее сформированный список обновляемых объектов, как и в основном решении. Обработка сценария, нарушения записи изменения остается за прикладными программистами.
> 
> 3. Доработки RatifyAuditOperationWithAutoFields
> 
> Возможен вариант использования сортировки как из доработок для AfterUpdateObjects(сортируем список AuditAdditionalInfo, по полученному вспомогательному списку), так и для AuditOperation(список полученных AuditAdditionalInfo совпадает с сортировкой списка объектов переданных в AuditOperation)
> Необходимо доработать сущность AuditAdditionalInfo, добавив в неё явную не хранимую ссылку на объект, либо передать в RatifyAuditOperationWithAutoFields дополнительно изменяемые объекты.

> Общая доработка для методов AuditOperation и RatifyAuditOperationWithAutoFields - передавать параметром метода текущую выполняемую транзакцию, что бы при необходимости можно было выполнить действия в одной транзакции с записями изменений и аудита.
