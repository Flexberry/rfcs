- Дата создания: 2022-09-20
- RFC PR: (оставьте изначально пустым)
- RFC Issue: -
- Flexberry Issue: -

# Единый подход к интеграционному тестированию генерируемых из Flexberry Designer приложений

## Краткое описание

Предлагается заложить в генерируемые из Flexberry Designer приложения единый подход, облегчающий быстрый старт и настройку CI/CDL (Continuous Integration/Continuous Delivery) для интеграционного тестирования этих приложений. Рассматривается только случай, когда приложение состоит из фронтенда и бекенда, исходный код которых располагается в одном репозитории, а интеграционные тесты задействуют БД. При этом интеграционные тесты, которые предлагается запускать, включают себя как написанные на C#, так и приемочные тесты EmberJS. Сценарии интеграционного тестирования взаимодействия нескольких сервисов или взаимодействия с брокером сообщений выходят за рамки данного RFC.

## Обоснование

Сейчас каждый проект сталкивается с необходимостью самостоятельно придумывать и настраивать автоматизированный запуск интеграционных тестов. Для этого требуется механизм автоматизированного создания БД (либо гарантированной очистки такой БД после прогона тестов), пригодной для осуществления тестовых проверок даже в сценарии с интеграционным тестированием только бекенда. В случае с тестированием взаимодействия фронтенда и бекенда проблема может усложняться необходимостью развертывания где-то бекенда из версии кода, соответствующей текущему тестируемому коммиту. Из-за сложности подобных настроек большинство проектов не используют интеграционное тестирование совсем, либо тестируют очень ограниченные сценарии работы.

## Детальное проектирование

### Требования
Предлагаемая данным RFC схема предполагает соблюдение следующих требований:
* Фронтенд и бекенд находятся в одном репозитории
* В качестве СУБД используется PostgreSQL
* Скрипты изменения БД и наполнения данными исполняются с помощью liquibase
* При тестировании каждый интеграционный тест создает для себя в БД нужное состояние, однако БД общая для разных интеграционных тестов в рамках одного запуска. То есть, если на проекте активировано многопоточное исполнение тестов, код тестов должен предусматривать возможность наличия в БД данных, созданных соседними тестами, и это не должно приводить к падению тестов. После выполнения тест должен удалить из БД свои тестовые данные.
* Параллельно могут выполняться несколько запусков интеграционных тестов, у каждого запуска должна быть своя БД
* Имеется механизм запуска интеграционных тестов на локальной машине разработчика

### Описание подхода
1. БД для интеграционного тестирования предлагается запускать в контейнере на раннере, исполняющем сборку и запуск тестов
2. В папке `SQL` проекта должны располагаться скрипты изменения БД в формате liquibase, а также настройки liquibase для подключения к БД. В папке `SQL/create_databases` должны располагаться скрипты создания пользователей и баз данных проекта (прикладной, БД аудита, БД полномочий и пр.)
3. В качестве образа с БД предлагается на старте проекта вручную создать и запушить в репозиторий образ с именем `<internal_registry>/<project_name>/<db_server_name>:latest` на базе образа с PostgreSQL. В образ с постгресом в `/docker-entrypoint-initdb.d/` должны быть скопированы скрипты из `SQL/create_databases`. В результате в образе будет запускаться PostgreSQL с пользователями и пустыми базами данных проекта. _В будущем возможно собрать и запушить более свежий образ с БД проекта, применив на нем часть скриптов миграции БД. Это может быть полезно в момент, когда время на создание и наполнение БД в ходе билда начнет составлять существенную часть от общего времени билда_
4. На первом шаге билда с помощью liquibase на запущенные БД должны примениться скрипты из папки `SQL`     
5. После этого исполняются интеграционные тесты бекенда (проекты с ними должны содержать в наименовании строку `IntegrationTests`)
   1. Если тесты прошли успешно, выполняется сборка докер-образа бекенда из файлов исходной ветки PR/MR `<internal_registry>/<project_name>/<backend>:<build_number>`
   2. Этот образ используется в качестве вспомогательного для шага интеграционных тестов фронтенда вместе с образом БД
6. При запуске интеграционных тестов фронтенда 
   1. в конфиге фронтенда для тестирования задается адрес бекенда, вычисленный на предыдущем шаге. Например, путем подмены в ember-cli-build.js 
   2. запускаются интеграционные тесты фронтенда
   3. после завершения тестов докер-образ бекенда для тестирования удаляется с внутреннего регистратора, чтобы не забивать диск

Данную последовательность шагов предлагается воплотить в виде GitLab-пайплайна, генерируемого при генерации приложения наряду с файлами бекенда и фронтенда.

Служебные скрипты, например для создания тестовой БД или применения скриптов изменения БД предпочтительно сложить в репозиторий в виде файлов, а не как части пайплайна, чтобы была возможность выполнять их локально, например при сборке локального образа с БД. 

## Документирование и обучение

Описание подхода из данного RFC после реализации необходимо будет дополнить деталями относительно возможностей настройки пайплайна на конкретном проекте и опубликовать в виде статьи в документацию по платформе.
 
## Альтернативы
* Запускать контейнеры с БД и с бекендом на специальном выделенном сервере для интеграционного тестирования. Данный вариант усложняет инфраструктуру проекта, поскольку требует отдельного сервера, куда будут развертываться тестовые сервисы, а также создания механизма запуска нескольких наборов сервисов приложения на одном сервере для нескольких запусков тестов

## Нерешенные вопросы
* Как реализовать подобные билды для проектов в Azure DevOps
* Не раскрыты детали реализации данной схемы для СУБД отличных от PostgreSQL